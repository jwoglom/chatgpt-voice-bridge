#!/command/with-contenv bash
# shellcheck shell=bash
set -e

echo "[pulseaudio-setup] Waiting for PulseAudio to be ready..."

# PulseAudio runs as user abc in linuxserver containers
# Set environment for abc user
export HOME=/config
export XDG_RUNTIME_DIR=/run/user/911
export DISPLAY=:1

# First wait for pulseaudio process to start (it depends on X11)
timeout=120
echo "[pulseaudio-setup] Waiting for PulseAudio process to start..."
while [ $timeout -gt 0 ]; do
    if pgrep -x pulseaudio >/dev/null 2>&1; then
        echo "[pulseaudio-setup] PulseAudio process found!"
        break
    fi
    sleep 1
    timeout=$((timeout - 1))
    if [ $((timeout % 10)) -eq 0 ]; then
        echo "[pulseaudio-setup] Still waiting for PulseAudio process... ($timeout seconds left)"
    fi
done

if [ $timeout -eq 0 ]; then
    echo "[pulseaudio-setup] ERROR: PulseAudio process not found after 120s"
    exit 1
fi

# Give PulseAudio a moment to initialize its socket
sleep 2

# Now wait for pactl to be able to connect
timeout=30
echo "[pulseaudio-setup] Waiting for PulseAudio to accept connections..."
while [ $timeout -gt 0 ]; do
    if s6-setuidgid abc pactl info >/dev/null 2>&1; then
        echo "[pulseaudio-setup] PulseAudio is accepting connections!"
        break
    fi
    sleep 1
    timeout=$((timeout - 1))
done

if [ $timeout -eq 0 ]; then
    echo "[pulseaudio-setup] ERROR: PulseAudio not accepting connections after 30s"
    echo "[pulseaudio-setup] Debug info:"
    pgrep -a pulseaudio || echo "No pulseaudio process"
    ls -la /run/user/911/pulse/ 2>/dev/null || echo "No pulse socket dir"
    exit 1
fi

# Create shared directory for call signaling
mkdir -p /alloc
chmod 777 /alloc

echo "[pulseaudio-setup] Creating virtual audio devices..."

# VirtualMic: Where Baresip plays audio TO (this goes to ChatGPT as microphone input)
s6-setuidgid abc pactl load-module module-null-sink \
    sink_name=VirtualMic \
    sink_properties=device.description="Input_To_ChatGPT"

# VirtualSpeaker: Where browser/ChatGPT audio goes (Baresip captures from this)
s6-setuidgid abc pactl load-module module-null-sink \
    sink_name=VirtualSpeaker \
    sink_properties=device.description="Output_From_ChatGPT"

# RealMic: Remap VirtualMic.monitor as a source so Chrome sees it as a microphone
s6-setuidgid abc pactl load-module module-remap-source \
    source_name=RealMic \
    master=VirtualMic.monitor \
    source_properties=device.description="ChatGPT_Microphone"

# Set defaults
s6-setuidgid abc pactl set-default-sink VirtualSpeaker
s6-setuidgid abc pactl set-default-source RealMic

echo "[pulseaudio-setup] Virtual audio routing configured:"
echo "  - VirtualMic sink (Baresip plays here -> goes to Chrome as mic)"
echo "  - VirtualSpeaker sink (Chrome plays here -> Baresip captures)"
echo "  - RealMic source (Chrome uses as microphone input)"
echo "[pulseaudio-setup] Done!"
