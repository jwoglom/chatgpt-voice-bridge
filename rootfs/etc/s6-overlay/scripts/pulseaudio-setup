#!/command/with-contenv bash
# shellcheck shell=bash
# Matches the post-startup logic from the original Nomad audio-hub task
set -e

echo "[pulseaudio-setup] Waiting for PulseAudio socket at /alloc/pulse/socket..."

# Wait for socket to appear (same pattern as original Nomad config)
while [ ! -S /alloc/pulse/socket ]; do
    sleep 1
done

echo "[pulseaudio-setup] Socket found. Adjusting permissions..."
chmod -R 777 /alloc/pulse

# Set defaults (matching original Nomad audio-hub task)
pactl -s unix:/alloc/pulse/socket set-default-source RealMic
pactl -s unix:/alloc/pulse/socket set-default-sink VirtualSpeaker

echo "[pulseaudio-setup] Done!"
