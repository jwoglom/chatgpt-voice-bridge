#!/command/with-contenv bash
# shellcheck shell=bash
set -e

CDP_PORT="${CHROME_DEBUGGING_PORT:-9229}"
CDP_URL="http://localhost:${CDP_PORT}"

echo "[svc-automation] Waiting for Chrome debugging port..."

# Wait for Chrome CDP to be available
timeout=120
while [ $timeout -gt 0 ]; do
    if curl -sf "${CDP_URL}/json/version" >/dev/null 2>&1; then
        echo "[svc-automation] Chrome CDP is ready!"
        break
    fi
    sleep 1
    timeout=$((timeout - 1))
done

if [ $timeout -eq 0 ]; then
    echo "[svc-automation] ERROR: Chrome debugging port not available after 120s"
    exit 1
fi

cd /app/automation
exec python3 -u bot.py
