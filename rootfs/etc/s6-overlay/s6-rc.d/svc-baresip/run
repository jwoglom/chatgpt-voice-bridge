#!/command/with-contenv bash
# shellcheck shell=bash
set -e

# Create baresip config directory
BARESIP_DIR="/config/.baresip"
mkdir -p "$BARESIP_DIR"
chown abc:abc "$BARESIP_DIR"

# Find module path
MOD_FILE=$(find /usr/lib -name pulse.so 2>/dev/null | grep baresip | head -n 1)
if [ -z "$MOD_FILE" ]; then
    echo "[svc-baresip] ERROR: Could not find baresip pulse.so module"
    exit 1
fi
MOD_PATH=$(dirname "$MOD_FILE")
export MOD_PATH

# Generate config from template using envsubst
envsubst < /etc/baresip/config.template > "$BARESIP_DIR/config"
envsubst < /etc/baresip/accounts.template > "$BARESIP_DIR/accounts"
chown abc:abc "$BARESIP_DIR/config" "$BARESIP_DIR/accounts"

echo "[svc-baresip] Starting Baresip with call detection..."

# Start baresip as user abc (to access PulseAudio) and monitor output for call events
exec s6-setuidgid abc baresip -f "$BARESIP_DIR" -v 2>&1 | while read -r line; do
    echo "$line"

    if echo "$line" | grep -q "call: answering call"; then
        echo "[svc-baresip] DETECTED CALL! Creating trigger..."
        touch /alloc/call_active
        chmod 777 /alloc/call_active
    fi

    if echo "$line" | grep -q "terminated"; then
        echo "[svc-baresip] Call ended. Removing trigger..."
        rm -f /alloc/call_active
    fi
done
