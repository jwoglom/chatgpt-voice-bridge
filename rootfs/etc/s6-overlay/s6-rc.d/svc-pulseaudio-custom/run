#!/command/with-contenv bash
# shellcheck shell=bash
# Custom PulseAudio service â€” closely matches original Nomad audio-hub task
set -e

echo "[svc-pulseaudio-custom] Starting PulseAudio..."

# Create socket directory (matching original Nomad config)
mkdir -p /alloc/pulse
rm -f /alloc/pulse/socket

# Create a runtime directory PulseAudio can actually use
mkdir -p /var/run/pulse
chmod 755 /var/run/pulse

# Set HOME to a writable location (the original Nomad container
# ran in debian:bookworm-slim where /root was writable; in this
# linuxserver image it isn't)
export HOME=/var/run/pulse
export XDG_RUNTIME_DIR=/var/run/pulse

# Run PulseAudio in background (matching original Nomad audio-hub task)
pulseaudio \
    --daemonize=no \
    --exit-idle-time=-1 \
    --verbose \
    --log-target=stderr \
    --load="module-native-protocol-unix socket=/alloc/pulse/socket auth-anonymous=1" \
    --load="module-null-sink sink_name=VirtualMic sink_properties=device.description=Input_To_ChatGPT" \
    --load="module-null-sink sink_name=VirtualSpeaker sink_properties=device.description=Output_From_ChatGPT" \
    --load="module-remap-source master=VirtualMic.monitor source_name=RealMic source_properties=device.description=ChatGPT_Microphone" &

PULSE_PID=$!
echo "[svc-pulseaudio-custom] Started PulseAudio (PID: $PULSE_PID). Waiting for socket..."

# Wait for socket
timeout=10
while [ ! -S /alloc/pulse/socket ]; do
    sleep 0.5
    timeout=$((timeout - 1))
    if [ $timeout -eq 0 ]; then
        echo "[svc-pulseaudio-custom] ERROR: PulseAudio socket failed to appear"
        exit 1
    fi
done

echo "[svc-pulseaudio-custom] Socket found. Setting defaults..."
# Set accessible permissions
chmod -R 777 /alloc/pulse

# Set defaults
pactl -s unix:/alloc/pulse/socket set-default-source RealMic
pactl -s unix:/alloc/pulse/socket set-default-sink VirtualSpeaker

echo "[svc-pulseaudio-custom] PulseAudio ready. Monitoring process..."
wait $PULSE_PID
