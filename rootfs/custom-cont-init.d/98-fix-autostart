#!/bin/bash
echo "[custom-init] Overwriting Openbox autostart script..."

# Ensure directory exists
mkdir -p /config/.config/openbox

# Clean up lock files as ROOT before switching to user
echo "[custom-init] Cleaning lock files..."
rm -f /config/SingletonLock
rm -f /config/SingletonCookie
rm -f /config/.config/chromium/SingletonLock
rm -f /config/.config/chromium/SingletonCookie

# Ensure the container user (abc) owns the config directory
# This fixes "Permission denied" errors when Chrome tries to write to its profile
echo "[custom-init] Fixing permissions on /config..."
chown -R abc:abc /config

# Write a robust autostart script specifically for this voice bridge
# We bypass wrapped-chromium to ensure we control the flags and binary
# We also redirect output to a log file for easier debugging
cat > /config/.config/openbox/autostart <<EOF
#!/bin/bash
# Redirect all output to log file
exec > /config/chrome_startup.log 2>&1

echo "--- Chrome Autostart \$(date) ---"
echo "CHROME_CLI: \$CHROME_CLI"

echo "Launching Chromium directly..."
# Launch Chromium with the defined CLI flags
exec /usr/lib/chromium/chromium \$CHROME_CLI
EOF

chmod +x /config/.config/openbox/autostart
chown abc:abc /config/.config/openbox/autostart
echo "[custom-init] Autostart script updated."
